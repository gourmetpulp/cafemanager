<script>
    // ────────────────────────────────────────────────
    //  FIREBASE CONFIG – replace these values
    // ────────────────────────────────────────────────
   const firebaseConfig = {
  apiKey: "AIzaSyDje-Gtq7xsYHJO_0WjMJvvIVC4bKYYHII",
  authDomain: "gp-workspace-manager.firebaseapp.com",
  projectId: "gp-workspace-manager",
  storageBucket: "gp-workspace-manager.firebasestorage.app",
  messagingSenderId: "359938483000",
  appId: "1:359938483000:web:bc9fa519fed44321a257cd",
  measurementId: "G-KF4C2MGND1"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence().catch(err => {
        if (err.code === 'failed-precondition') {
            console.warn("Persistence failed – multiple tabs open");
        } else if (err.code === 'unimplemented') {
            console.warn("Persistence not supported in this browser");
        }
    });

    let slots = {};
    let timers = {};

    const SLOT_DURATION_MS = 2 * 60 * 1000;  // 2 minutes for testing (change to 2*60*60*1000 later)

    function updateDateTime() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
        document.getElementById('current-datetime').textContent = now.toLocaleString('en-IN', options) + ' IST';
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    async function startSlot() {
        let table = document.getElementById('table-name').value.trim();
        const mobile = document.getElementById('mobile').value.trim();
        const name   = document.getElementById('customer-name').value.trim();

        if (!table || !name) return alert("Table and Name are required");
        if (mobile && (mobile.length !== 10 || !/^\d{10}$/.test(mobile))) {
            return alert("Mobile number must be exactly 10 digits");
        }

        // Normalize table to lowercase for case-insensitive check
        const tableLower = table.toLowerCase();

        try {
            console.log(`Checking for active slot with table_lower = "${tableLower}"`);

            // Query using table_lower (preferred) or fallback to table lowercase
            const tableQuery = await db.collection('slots')
                .where('table_lower', '==', tableLower)
                .where('end', '>', firebase.firestore.Timestamp.now())
                .get();

            if (tableQuery.empty) {
                // Fallback: check original table field in lowercase
                const fallbackQuery = await db.collection('slots')
                    .where('table', '==', table.toUpperCase())
                    .where('end', '>', firebase.firestore.Timestamp.now())
                    .get();

                if (!fallbackQuery.empty) {
                    console.log("Found duplicate via fallback (original table field)");
                    return alert(`Table ${table} is already occupied!`);
                }
            } else {
                console.log("Found duplicate via table_lower field");
                return alert(`Table ${table} is already occupied!`);
            }

            // Mobile check (unchanged)
            if (mobile) {
                const mobileQuery = await db.collection('slots')
                    .where('mobile', '==', mobile)
                    .where('end', '>', firebase.firestore.Timestamp.now())
                    .get();

                if (!mobileQuery.empty) {
                    return alert(`Mobile ${mobile} is already in an active session!`);
                }
            }

            // All checks passed → create slot
            const now = new Date();
            const end = new Date(now.getTime() + SLOT_DURATION_MS);

            await db.collection('slots').add({
                table: table.toUpperCase(),        // display-friendly
                table_lower: tableLower,           // for fast case-insensitive queries
                mobile: mobile || null,
                name,
                start: firebase.firestore.Timestamp.fromDate(now),
                end:   firebase.firestore.Timestamp.fromDate(end)
            });

            alert("Slot started successfully!");

            document.getElementById('table-name').value = '';
            document.getElementById('mobile').value = '';
            document.getElementById('customer-name').value = '';
        } catch (err) {
            console.error("Start slot error:", err);
            alert("Error starting slot: " + err.message);
        }
    }

    // ────────────────────────────────────────────────
    // renewSlot, loadSlots, setupTimer, showExpirationNotification, updateSlotsUI
    // (unchanged from previous version – copy them from your last working code)
    // ────────────────────────────────────────────────

    function renewSlot(slotId) {
        const slotData = slots[slotId];
        if (!slotData) return;

        if (!confirm("Extend this slot by another 2 minutes?")) return;

        const now = Date.now();
        const currentEnd = slotData.end.toDate().getTime();
        const newEndTime = Math.max(now, currentEnd) + SLOT_DURATION_MS;

        db.collection('slots').doc(slotId).update({
            end: firebase.firestore.Timestamp.fromDate(new Date(newEndTime))
        })
        .then(() => console.log(`Slot ${slotId} extended`))
        .catch(err => alert("Renew failed: " + err.message));
    }

    function loadSlots() {
        db.collection('slots')
            .where('end', '>', firebase.firestore.Timestamp.now())
            .onSnapshot(snap => {
                console.log(`Received ${snap.size} active slots`);
                slots = {};
                snap.forEach(doc => {
                    slots[doc.id] = doc.data();
                    setupTimer(doc.id, slots[doc.id]);
                });
                updateSlotsUI();
            }, err => {
                console.error("Firestore listener error:", err);
                alert("Database connection issue. Check internet or Firebase rules.");
            });
    }

    function setupTimer(slotId, slotData) {
        if (timers[slotId]) clearTimeout(timers[slotId]);

        const msLeft = slotData.end.toDate() - Date.now();
        if (msLeft > 0) {
            timers[slotId] = setTimeout(() => {
                showExpirationNotification(slotData);
                delete timers[slotId];
            }, msLeft);
        }
    }

    function showExpirationNotification(slotData) {
        const banner = document.createElement('div');
        banner.className = 'notification-banner';
        banner.innerHTML = `Time's up! Table <strong>${slotData.table}</strong> – ${slotData.name || '—'}`;
        document.body.appendChild(banner);
        setTimeout(() => banner.remove(), 10000);

        try {
            const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1000).join('Ag'));
            audio.volume = 0.7;
            audio.play().catch(e => console.warn("Beep failed:", e));
        } catch (e) {
            console.warn("Beep attempt failed:", e);
        }

        alert(`Time's up! Table ${slotData.table} – ${slotData.name || '—'}`);
    }

    function updateSlotsUI() {
        const container = document.getElementById('slots');
        container.innerHTML = '';
        const now = Date.now();

        Object.entries(slots).forEach(([id, data]) => {
            const endTime = data.end.toDate().getTime();
            const startTime = data.start.toDate().getTime();
            const totalMs = endTime - startTime;
            const remainingMs = endTime - now;
            let percent = totalMs > 0 ? (remainingMs / totalMs) * 100 : 0;
            percent = Math.max(0, Math.min(100, percent));

            let statusText = remainingMs <= 0
                ? 'Expired'
                : `${Math.floor(remainingMs/60000)}m ${Math.floor((remainingMs%60000)/1000)}s left`;

            let progressClass = remainingMs <= 0 ? 'progress-red' :
                percent > 50 ? 'progress-green' :
                percent > 20 ? 'progress-orange' : 'progress-red';

            const item = document.createElement('div');
            item.className = 'slot-item' + (remainingMs <= 0 ? ' expired' : '');
            item.innerHTML = `
                <div style="font-weight:500; font-size:1.1rem;">
                    Table <strong>${data.table}</strong> • ${data.name || '—'} • ${data.mobile || '—'}
                </div>
                <div style="color:var(--text-muted);">${statusText}</div>
                <div class="progress-container">
                    <div class="progress-bar ${progressClass}" style="width: ${percent}%"></div>
                </div>
            `;

            if (remainingMs > 0) {
                const btn = document.createElement('button');
                btn.className = 'renew-btn';
                btn.textContent = 'Extend 2 min';
                btn.onclick = () => renewSlot(id);
                item.appendChild(btn);
            }

            container.appendChild(item);
        });

        if (Object.keys(slots).length === 0) {
            container.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:3rem 0; font-size:1.1rem;">No active sessions at the moment.</p>';
        }
    }

    // Initialize
    loadSlots();
    setInterval(updateSlotsUI, 1000);
</script>
