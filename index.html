<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Slot Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
        }
        .form-container, .login-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        input[type="text"], input[type="email"], input[type="password"], input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .slot-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .slot-item {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .slot-item:last-child {
            border-bottom: none;
        }
        .expired {
            color: red;
            font-weight: bold;
        }
        .actions button {
            width: auto;
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .renew-btn {
            background-color: #2196F3;
        }
        .renew-btn:hover {
            background-color: #1E88E5;
        }
        .remove-btn {
            background-color: #f44336;
        }
        .remove-btn:hover {
            background-color: #d32f2f;
        }
        #logoutBtn {
            width: auto;
            background-color: #f44336;
            margin-top: 20px;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .slot-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .actions {
                margin-top: 10px;
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js"></script>
</head>
<body>
    <h1>Cafe Slot Manager</h1>
    
    <div id="loginContainer" class="login-container">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <button onclick="signup()" style="background-color: #2196F3; margin-top: 10px;">Sign Up</button>
    </div>
    
    <div id="mainContainer" style="display: none;">
        <div class="form-container">
            <input type="text" id="tableName" placeholder="Table Name/Number" required>
            <input type="text" id="mobileNumber" placeholder="10-Digit Mobile Number" pattern="\d{10}" required>
            <input type="text" id="customerName" placeholder="Customer Name" required>
            <input type="file" id="ringtone" accept="audio/*">
            <button onclick="startSlot()">Start Slot</button>
        </div>
        
        <div class="slot-list" id="slotList"></div>
        
        <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
    
    <audio id="alarmAudio" loop></audio>

    <script>
        // Replace with your own Firebase config
        const firebaseConfig = {
  apiKey: "AIzaSyDje-Gtq7xsYHJO_0WjMJvvIVC4bKYYHII",
  authDomain: "gp-workspace-manager.firebaseapp.com",
  projectId: "gp-workspace-manager",
  storageBucket: "gp-workspace-manager.firebasestorage.app",
  messagingSenderId: "359938483000",
  appId: "1:359938483000:web:bc9fa519fed44321a257cd",
  measurementId: "G-KF4C2MGND1"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        const slotsRef = database.ref('slots');
        const ringtoneRef = database.ref('ringtone');

        let ringtoneUrl = null;
        const alarmAudio = document.getElementById('alarmAudio');
        let alarmInterval;

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                loadRingtone().then(displaySlots);
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        });

        // Login function
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert(error.message));
        }

        // Signup function
        function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => alert(error.message));
        }

        // Logout function
        function logout() {
            auth.signOut();
        }

        // Load custom ringtone from DB
        async function loadRingtone() {
            const ringtoneSnapshot = await ringtoneRef.once('value');
            if (ringtoneSnapshot.val()) {
                ringtoneUrl = ringtoneSnapshot.val();
                alarmAudio.src = ringtoneUrl;
            }
        }

        // Upload new ringtone if selected
        document.getElementById('ringtone').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const storageRef = storage.ref('ringtones/custom_ringtone');
                const uploadTask = storageRef.put(file);
                uploadTask.on('state_changed', null, error => alert(error.message), async () => {
                    ringtoneUrl = await uploadTask.snapshot.ref.getDownloadURL();
                    alarmAudio.src = ringtoneUrl;
                    ringtoneRef.set(ringtoneUrl);
                });
            }
        });

        // Start a new slot
        function startSlot() {
            const tableName = document.getElementById('tableName').value.trim();
            const mobileNumber = document.getElementById('mobileNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();

            if (!tableName || !/^\d{10}$/.test(mobileNumber) || !customerName) {
                alert('Please fill all fields correctly. Mobile must be 10 digits.');
                return;
            }

            const startTime = Date.now();
            const slotId = tableName.replace(/\s/g, '_');  // Simple ID from table name

            slotsRef.child(slotId).set({
                tableName,
                mobileNumber,
                customerName,
                startTime
            });

            document.getElementById('tableName').value = '';
            document.getElementById('mobileNumber').value = '';
            document.getElementById('customerName').value = '';
        }

        // Renew slot
        function renewSlot(slotId) {
            slotsRef.child(slotId).update({ startTime: Date.now() });
        }

        // Remove slot
        function removeSlot(slotId) {
            slotsRef.child(slotId).remove();
        }

        // Display slots and check timers
        function displaySlots() {
            const slotList = document.getElementById('slotList');
            slotList.innerHTML = '';

            slotsRef.once('value').then(snapshot => {
                let hasExpired = false;
                snapshot.forEach(child => {
                    const slotId = child.key;
                    const slot = child.val();
                    const elapsed = Date.now() - slot.startTime;
                    const remaining = (2 * 60 * 60 * 1000) - elapsed;  // 2 hours in ms
                    const timeLeft = remaining > 0 ? Math.floor(remaining / 60000) + ' min' : 'Expired';

                    const div = document.createElement('div');
                    div.className = 'slot-item';
                    if (remaining <= 0) {
                        div.classList.add('expired');
                        hasExpired = true;
                    }
                    div.innerHTML = `
                        <div>
                            Table: ${slot.tableName}<br>
                            Name: ${slot.customerName}<br>
                            Mobile: ${slot.mobileNumber}<br>
                            Time Left: ${timeLeft}
                        </div>
                        <div class="actions">
                            <button class="renew-btn" onclick="renewSlot('${slotId}')">Renew</button>
                            <button class="remove-btn" onclick="removeSlot('${slotId}')">Remove</button>
                        </div>
                    `;

                    slotList.appendChild(div);
                });

                if (hasExpired && ringtoneUrl) {
                    if (!alarmInterval) {
                        alarmAudio.play();
                        alarmInterval = setInterval(() => {
                            displaySlots();  // Refresh to check
                            if (!document.querySelector('.expired')) {
                                alarmAudio.pause();
                                clearInterval(alarmInterval);
                                alarmInterval = null;
                            }
                        }, 10000);  // Check every 10s
                    }
                } else {
                    alarmAudio.pause();
                }
            });
        }

        // Real-time listener for updates
        slotsRef.on('value', displaySlots);

        // Refresh every minute to update times
        setInterval(displaySlots, 60000);
    </script>
</body>
</html>
